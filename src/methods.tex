\chapter{Materials and Methods}

\section{Dataset Description}
59 acute comatose patients were included in the study between 7 days and 30 days after the coma onset (46 ± 16 years old; 21 females).
PET data were acquired in list mode during 90 min from the injection of an intravenous bolus of \fdg.
Simultaneously, an arterial time-of-flight MR (TOF-MRA)  in axial orientation, with a voxel size of 0.3$\times$0.3$\times$0.7 mm as well as a T1-weighted MRI in axial orientation, with isometric voxel size of 1mm were acquired.
Raw PET data were rebinned into 24-time frames (variable length frames : 8$\times$15 s, 3$\times$60 s, 5$\times$120 s, 1$\times$300 s, 7$\times$600 s) sinograms for dynamic reconstruction.
Reconstruction yielded a voxel size of 1.04$\times$1.04$\times$2.08 mm$^3$ in a matrix of 344$\times$344$\times$127 voxels.

AIF in the whole blood and plasma were measured from 26 arterial blood samples manually collected (with the following timing: every 5 s for the first minute, every 15 s until second minute, and at times 3, 5, 10, 20, 30, 45, 60, 75, 80, 85 and 90 minutes post-injection) and counted with a gamma counter.

\section{Pre-processing}
Even though the patients were completely unconscious and the PET and MRI images were acquired simultaneously, out of an abundance of caution, the T1-weighted image was registered to both the average PET image and to the TOF-MRA image using a affine registration method.
The two resulting affine transformation matrices were then combined to register the TOF-MRA directly to the PET.
The T1-weighted image was used as a medium since it has common spatial features with both the other two modalities and directly registering TOF-MRA to the PET would be impractical due to the low spatial resolution of the PET and the limited axial FOV of the TOF-MRA images.

\section{Carotid Segmentation\label{sec:carotid}}
Figure~\ref{fig:seg_pipeline} shows the complete pipeline for the carotid segmentation.
Since vessels appear as hypersignal in TOF-MRA, a high-intensity thresholding technique can be used to extract the arteries from the image.
However, other tissues such as  brain lesion ---which were very common in the comatose dataset--- and venous structures may also appear as hypersignal and can interfere with the selection.
To exclude them, in a reference image, a cuboid volume of interest (VOI) was defined where the carotid arteries are most likely to appear (Step I).
The threshold value was calculated as the 1\% percentile of all non-zero voxels in the image and then it was applied to only to the voxels inside the VOI (Step II).
A 3D connectivity constraint was employed to the remaining voxels to extract all fully connected volumes and among those, the top 2 biggest were consider as the left and right internal carotid artery and extracted(Step III).

The reference image used was the standard MNI152 atlas, which was padded by 50\% more voxels in the inferior direction of the brain (negative Z in voxel-space) since the original atlas excludes the area below the brain which is of the interest for us.

The TOF-MRA image was then registered to the reference image using an affine registration technique and the obtained affine matrix was used to register and then apply the VOI to the TOF-MRA.

\begin{figure}[h]
	\centering
	\begin{tikzpicture}[
			node distance=1cm,
			auto,
			>=Stealth,
			mybox/.style={draw, rounded corners, rectangle, minimum width=3cm, minimum height=1cm, align=center}
		]
		\node[mybox] (input) {TOF-MRA};
		\node[mybox, right=of input] (cuboid) {I) Cuboid Mask\\Application};

		\node[mybox, right=of cuboid] (thresh) {II) Adaptive\\ Threshold};
		\node[mybox, below=of thresh] (growing) {III) Largest 2 Regions};
		\node[mybox, left=of growing] (dilation) {IV) Dilation};
		\node[mybox, below=of growing] (mask) {Carotid\\Mask};
		\node[mybox, below=of dilation] (bg_mask) {Background\\Mask};

		\draw[->] (input) -- (cuboid);
		\draw[->] (cuboid) -- (thresh);
		\draw[->] (thresh) -- (growing);
		\draw[->] (growing) -- (mask);
		\draw[->] (growing) -- (dilation);
		\draw[->] (dilation) -- (bg_mask);
	\end{tikzpicture}
	\caption{Carotid and background mask segmentation pipeline}
	\label{fig:seg_pipeline}
\end{figure}

\section{Partial Volume Correction}
\subsection{Geometric Transfer Matrix}
As we discussed before in \ref{TODO}, direct extraction of the radioactivity in the arteries is not practical due to PVC.
Geometric Transfer Matrix aims to account for this loss of signal by considering the observed TACs are linear combination of the true value and other effecting regions \cite{rousset1998correction}.

Here we define two regions, the carotid and the surrounding tissues (background).
A mask for extracting the activities of the latter was obtained by dilating the carotid mask by 5 pixels and subtracting the voxels corresponding to the carotid mask (Figure~\ref{fig:seg_pipeline}, Step IV).

\begin{equation}
	\underbrace{
		\begin{bmatrix}
			T_{c} \\
			T_{bg}
		\end{bmatrix}
	}_{\text{Observed}}
	=
	\underbrace{
		\begin{bmatrix}
			\omega_{c \rightarrow c}  & \omega_{bg \rightarrow c}  \\
			\omega_{c \rightarrow bg} & \omega_{bg \rightarrow bg}
		\end{bmatrix}
	}_{\text{GTM}}
	.
	\underbrace{
		\begin{bmatrix}
			T_{IF} \\
			T_{tissue}
		\end{bmatrix}
	}_{\text{Unknown}},
\end{equation}

where $\omega_{n \rightarrow m}$ are the spill-in and spill-over coefficient of region $n$ onto region $m$, which is obtained by convolving the binary mask of region $n$ with the system's point spread function and integrating the resulting intensity over region $m$, normalized by the total signal in region $m$.
where
\begin{equation}
	\omega_{n\to m} = \frac{\displaystyle \int_{\Omega_m} \bigl( h \ast \chi_n \bigr)(r)\,dr}{\displaystyle \int_{\Omega_m} \bigl( h \ast \chi_m \bigr)(r)\,dr},
\end{equation}
with \(\chi_n\) and \(\chi_m\) denoting the binary masks of regions \(n\) and \(m\), respectively, \(h\) the system's point spread function, and \(\Omega_m\) the spatial domain of region \(m\).

$T_{c}$ and $T_{bg}$ are respectively the observed carotid and background TACs and $T_{IF}$ and $T_{tissue}$ are the real unknown TACs of the carotid (the input function) and the background tissue.

By inverting the GTM, this system of equations can be easily solved and the "true" TAC in the artery and background be computed.
% However, through a combination of small size of the carotids and short time frames and exponential decay of the tracer
However, GTM along with other classical PVE methods usually fail to fully recover the lost signal as they are a simplification that does not consider the whole picture particularly accounting for the time-variant noise experienced in the signal.
This causes these methods to not only fail to correct the noise but end up amplifying them because of their assumptions.
The time-variant noise can be attributed to number of contributing factors, namely, the small size of the arteries, very short frame-times at the beginning of the scan where the changes in the input function are very rapid and rapid decay of the radiotracer which in all result in low-count statistic hence having higher noise.

However, the GTM being a low rank matrix makes the inversion sensitive to noise and biased on small regions such as the carotid \cite{zanotti2011image, boellaard2004effects}.

\subsection{Bayesian Geometric Transfer Matrix}
\subsubsection{Modelling}
% To overcome challenges posed to GTM method, we utilized a Bayesian framework that jointly estimates the input function, the tissue activity and the system noise\cite{irace2021bayesian}.
For each subject, $T_{IF}$ is modeled as a linear combination of a population mean and its principal components.
These components are derived by performing principal component analysis (PCA) on a set of arterial input functions (AIFs) collected from the population.
Specifically, for each subject, a subset of 20 random subjects is selected from the dataset—excluding the subject under study—to construct the PCA model.
The data are first zero-centered, and PCA is applied to extract the principal axes \(\phi_i(t)\) and their corresponding explained variances \(\lambda_i\).
Each axis is then scaled by \(\sqrt{\lambda_i}\) to yield components \(v_i(t)\) with distribution of \(\mathcal{N}(0,1)\). The input function is then modeled as:

\begin{equation}
	T_{IF}(t) = \mu(t) + \sum_{i=1}^3 \theta_i\,v_i(t),
\end{equation}

with
\[
	v_i(t) = \sqrt{\lambda_i}\,\phi_i(t),
\]
where \(\mu(t)\) is the population mean AIF, \(\phi_i(t)\) are the principal axes obtained from PCA, \(\lambda_i\) are their explained variances, and \(v_i(t)\) are the scaled components. Due to this scaling, the weighting coefficients \(\theta_i\) will have a distribution of \(\sim \mathcal{N}(0,1)\).

Spectral Analysis (SA) has been proposed as a decomposition method for describing the tissue activity in dynamic PET.
This method produces a spectrum of kinetic components by modelling the TACs as a convolution of the input function with a impulse response function \cite{TODO}.

The impulse response function is considered as sum of multiple exponentials. Therefor the background TAC will be
\[
	T_{bg} = \sum_{i=1}^k \alpha_{i} \cdot T_{IF} \circledast e^{-\beta_{i} t}.
\]
Where \(alpha_i\) is the weighting factor
The number of basis functions (\(k\)) should be selected so it can accurately describe the activity of the tracer while avoiding being chosen too high to avoid over complicating and also introducing noise.
For \fdg, the optimal number of basis function was found to be just one.


Accurately modelling the noise is nearly impossible as there are numerous sources of them.
Some sources of noise such as scattering effect, random events, and motion artifacts among others are corrected to some degree by the reconstruction program.
However the biggest contributer of noise is "low-count statistics" which is caused by short time frames at the begin of the scan and by the exponential decay of the radioisotope towards the end of the scan apparent by the low dose of the tracer injection.
This combined with the samll size of the carotid introduces a massive challenge for recovering the lost signal.

Noise in raw PET counts is considered to be a Poisson distribution however after the reconstruction process it is widely assumed to be a Gaussian distribution \cite{TODO}. To account for the previously mentioned time-variant noise, weights are used to normalize the noise along all frames to a single statistic. We define the weights as
\[
	\omega_{i} = \frac{\Delta t_i}{c_i} e^{\frac{-t_{i} ln(2)}{T_{1/2}}}
\]
where \(\omega_i\) is the weight, \(\Delta t_i\) is the frame duration, and \(c_i\) is the net-true counts detected by the PET camera at the \(i\)th frame and  \(T_{1/2}\) is the half-life of the radioisotope.
However, \(c_i\) was substituted here with \(C_T(t_i)\), the total radioactivity concentration at the mid-time frame due to unavalibility of these counts in our dataset.

The time-variant noise can be normalized as the weighted mean of the per frame noise:

\[
	\eta= \frac{1}{N} \sum_{i=1}^{N} \omega_i \eta_{i}.
\]

\subsubsection{Estimation}
Let us define  \(\mathcal{D}\) as the observed PET TAC, \( \Theta = (\theta_{1}, \theta_{2}, \theta_{3}, \alpha_{1}, \beta_{1}, \dots) \) the set of parameters describing the system, and consider a Gaussian noise present in the system \(\eta\) with \(\Theta\) and \(\eta\) being unknown. We seek to estimate the joint probability \(p(\Theta,\eta \mid \mathcal{D})\) of the model parameters \(\Theta\) and noise level given the observed data \(\mathcal{D}\)

According to the Bayes rule:
\[
	p(\Theta,\eta \mid \mathcal{D}) \propto p(\mathcal{D} \mid \Theta,\eta) \cdot \pi( \Theta ) \cdot \pi( \eta )
\]

where  \(p(\Theta,\eta \mid \mathcal{D})\) is the posterior distribution, \(p(\mathcal{D} \mid \Theta,\eta)\) is the likelihood, and $\pi(\Theta)$ and $\pi(\eta)$ are the prior knowledge that we have on the set of parameters and the noise. Thus we can sample the posterior distribution given we can calculate the likelihood and the priors.

The likelihood is


Parameter estimation is performed using a Metropolis-within-Gibbs Markov Chain Monte Carlo (MCMC) sampler, which explores the posterior distribution of both the kinetic parameters of the tissue activity and the PCA coefficients of the input function and the noise in the system.
In the Bayesian framework \cite{irace2021bayesian}, all model parameters are collected into the vector $\Theta$. The posterior distribution of $\Theta$ given the observed data $\mathcal{D}$ is expressed as
\begin{equation}
	p(\Theta \mid \mathcal{D}) \propto p(\mathcal{D} \mid \Theta) \pi(\Theta),
\end{equation}

where \( p(\mathcal{D} \mid \Theta) \) is the likelihood function and \( \pi(\Theta) \) is the prior distribution over the parameters \( \Theta = (\theta_{1}, \theta_{2}, \theta_{3}, \alpha_{1}, \beta_{1}, \dots) \). The maximum a posteriori (MAP) estimate of \( \Theta \) is given by:

\begin{equation}
	\hat{\Theta}
	=
	\arg\max_{\Theta}
	\left\{
	\ln p(\mathcal{D} \mid \Theta)
	+
	\ln \pi(\Theta)
	\right\}.
\end{equation}

\section{Evaluation}
\subsection{IF Curves}
The performance of the proposed IDIF estimation was first evaluated by computing the mean absolute error (MAE) between the cumulative area under the curve (cAUC) of the estimated IDIF and the \textit{ground true} AIF. cAUC was considered to be a more suitable metric since it provides an integrated measure of tracer exposure over time and is less sensitive to local fluctuations or noise in the curve compared to the directly comparing the TACs.
\begin{equation}
	\textrm{cAUC}(t) =  \int_{0}^{t} IF(\tau) \, d\tau,
\end{equation}
where \(IF\) is the input function.

\subsection{Quantification}
However, because the cAUC error does not fully capture the impact of IDIF deviations on kinetic parameters, absolute quantification was also performed to evaluate the performance of the estimated IDIF against the gold standard AIF.
This was achieved by utilzing an irreversible two-tissue compartment model (2TCM) via non-linear fitting with the \texttt{fitk3} program from the TPCCLIB library developed at the Turku PET Centre \cite{oikonen2018tpcclib}—applying the model fitting once with the IDIF and once with the AIF as the input function.

The brain was segmented into regions of interest (ROI) based on the Hammersmith brain atlas \cite{hammers2003three}, and TACs were generated by averaging voxels over each ROI at every time point.
The regional influx rate (\(K_i\)) was then calculated, from which the corresponding \(\mrglu\) values were derived.

The mean absolute percentage error (MAPE) of the \(\textrm{MR}_{glu}\) in each ROI was calculated and then averaged across the entire dataset:
\begin{equation}
	\text{Average MAPE}(\mrglu)= \frac{100\%}{N} \sum_{i=1}^{N} \left( \frac{1}{N_{\text{ROI}}} \sum_{j=1}^{N_{\text{ROI}}} \left| \frac{\textrm{MR}_{\textrm{glu},ij}^{\textrm{IDIF}} - \textrm{MR}_{\textrm{glu},ij}^{\textrm{AIF}}}{\textrm{MR}_{\textrm{glu},ij}^{\textrm{AIF}}} \right| \right),
\end{equation}
where $N$ is the number of subjects.

Additionally, linear least-squares regression was performed between the regional \(\mrglu\) obtained by quantification with using AIF and IDIF for each subject. The coefficient of determination (\(R^2\)) and the regression slope (\(S\)) were obtained for each subject. The mean absolute errors of these metrics across the dataset are given by
\begin{equation}
	\text{MAE}(R^2) = \frac{1}{N} \sum_{i=1}^{N} \left| R^2_i - 1 \right|
\end{equation}
and
\begin{equation}
	\text{MAE}(S) = \frac{1}{N} \sum_{i=1}^{N} \left| S_i - 1 \right|,
\end{equation}
where $N$ is the number of subjects and \(R^2_i\) and \(S_i\) denote the coefficient of determination and the regression slope for subject \(i\), respectively.
